<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>ScheduledReaction Demo</title>
        <style>
            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }

            body {
                font-family: system-ui, -apple-system, sans-serif;
                background: #0a0a0f;
                color: #e8e8f0;
                min-height: 100vh;
                padding: 48px;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
            }

            h1 {
                font-size: 1.2rem;
                font-weight: 500;
                margin-bottom: 48px;
                color: #888;
            }

            .grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 48px;
            }

            .panel {
                text-align: center;
            }

            .label {
                font-size: 0.8rem;
                color: #666;
                margin-bottom: 16px;
                text-transform: uppercase;
                letter-spacing: 0.1em;
            }

            .action-btn {
                width: 200px;
                height: 200px;
                font-family: inherit;
                font-size: 1rem;
                font-weight: 600;
                border: 2px solid #333;
                border-radius: 16px;
                background: #1a1a24;
                color: #fff;
                cursor: pointer;
                transition: transform 0.1s;
            }

            .action-btn:hover {
                border-color: #555;
            }

            .action-btn:active {
                transform: scale(0.98);
            }

            .action-btn.active {
                background: #00ff88;
                border-color: #00ff88;
                color: #000;
                box-shadow: 0 0 60px rgba(0, 255, 136, 0.4);
            }

            .reset-btn {
                margin-top: 48px;
                padding: 12px 24px;
                font-family: inherit;
                font-size: 0.85rem;
                border: 1px solid #333;
                border-radius: 8px;
                background: transparent;
                color: #888;
                cursor: pointer;
            }

            .reset-btn:hover {
                border-color: #555;
                color: #fff;
            }
        </style>
    </head>
    <body>
        <h1>Click each button â€” it should turn green instantly</h1>

        <div class="grid">
            <div class="panel">
                <div class="label">Regular Reaction</div>
                <button class="action-btn" id="btn1">Click</button>
            </div>

            <div class="panel">
                <div class="label">ScheduledReaction</div>
                <button class="action-btn" id="btn2">Click</button>
            </div>
        </div>

        <button class="reset-btn" id="resetBtn">Reset</button>

        <script src="./dist/mobx.umd.development.js"></script>
        <script>
            const { observable, computed, Reaction, ScheduledReaction, runInAction } = mobx

            const SECONDARY_COUNT = 100
            const COMPUTED_WORK = 1000000

            const state1 = observable({ clickCount: 0 })
            const state2 = observable({ clickCount: 0 })

            let reactions1 = []
            let reactions2 = []

            function createNextTaskScheduler() {
                const pending = new Set()
                let scheduled = false

                return function (reaction) {
                    pending.add(reaction)
                    if (!scheduled) {
                        scheduled = true
                        setTimeout(() => {
                            scheduled = false
                            const toRun = Array.from(pending)
                            pending.clear()
                            for (const r of toRun) {
                                r.runReaction_()
                            }
                        }, 100)
                    }
                }
            }

            const nextTaskScheduler = createNextTaskScheduler()

            function doExpensiveWork(iterations) {
                let result = 0
                for (let i = 0; i < iterations; i++) {
                    result += Math.sqrt(i) * Math.sin(i)
                }
                return result
            }

            function setup() {
                reactions1.forEach(r => r.dispose())
                reactions2.forEach(r => r.dispose())
                reactions1 = []
                reactions2 = []

                document.getElementById("btn1").classList.remove("active")
                document.getElementById("btn2").classList.remove("active")

                runInAction(() => {
                    state1.clickCount = 0
                    state2.clickCount = 0
                })

                // === Regular Reaction ===
                const primary1 = new Reaction("Primary1", function () {
                    this.track(() => {
                        if (state1.clickCount > 0) {
                            document.getElementById("btn1").classList.add("active")
                        }
                    })
                })
                primary1.schedule_()
                reactions1.push(primary1)

                for (let i = 0; i < SECONDARY_COUNT; i++) {
                    const c = computed(() => {
                        doExpensiveWork(COMPUTED_WORK)
                        return state1.clickCount * (i + 1)
                    })

                    const r = new Reaction(`Secondary1_${i}`, function () {
                        this.track(() => void c.get())
                    })
                    r.schedule_()
                    reactions1.push(r)
                }

                // === ScheduledReaction ===
                const primary2 = new Reaction("Primary2", function () {
                    this.track(() => {
                        if (state2.clickCount > 0) {
                            document.getElementById("btn2").classList.add("active")
                        }
                    })
                })
                primary2.schedule_()
                reactions2.push(primary2)

                for (let i = 0; i < SECONDARY_COUNT; i++) {
                    const c = computed(() => {
                        doExpensiveWork(COMPUTED_WORK)
                        return state2.clickCount * (i + 1)
                    })

                    const r = new ScheduledReaction(
                        `Secondary2_${i}`,
                        function () {
                            this.track(() => void c.get())
                        },
                        nextTaskScheduler
                    )
                    r.schedule_()
                    reactions2.push(r)
                }
            }

            document.getElementById("btn1").addEventListener("click", () => {
                if (state1.clickCount > 0) return
                runInAction(() => state1.clickCount++)
            })

            document.getElementById("btn2").addEventListener("click", () => {
                if (state2.clickCount > 0) return
                runInAction(() => state2.clickCount++)
            })

            document.getElementById("resetBtn").addEventListener("click", setup)

            setup()
        </script>
    </body>
</html>
